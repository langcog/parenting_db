---
title: "Parenting Project - Database exploration"
author: "Mike & Emily"
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: true
number_sections: true
runtime: shiny

---
```{r}
knitr::opts_chunk$set(fig.width=8, fig.height=5, 
                      echo=TRUE, warning=FALSE, message=FALSE, cache=FALSE)
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(langcog))
library(stringr)
library(tidyr)
library(lubridate)
theme_set(theme_bw())

load("kinedu_1M_3-10-16.Rdata")
```

Now get the most frequent of these, and use these to filter out the curves we want to plot. 

```{r}
freq_indicators <- d %>%
  group_by(indicator_id) %>%
  summarise(n = n()) 
# %>%
  # filter(n > quantile(n, .80))

ms <- d %>%
  filter(indicator_id %in% freq_indicators$indicator_id) %>%
  group_by(indicator_id, age_months) %>%
  summarise(answer = mean(answer), 
            n = n()) %>%
  left_join(indicator_info) %>% 
  filter(n > 3)
```

One panel. 

```{r}
target_cat <- "touch"

ggplot(filter(ms, cat_name == target_cat),
       aes(x = age_months, y = answer, col = eng_desc)) + 
  geom_point() + 
  geom_smooth(se=FALSE, method="lm", formula = y ~ log(x)) + 
  scale_colour_solarized(guide=FALSE) + 
  facet_wrap(~cat_name) + 
  ylim(c(0,1)) + 
  ggrepel::geom_text_repel(data = filter(ms, cat_name == target_cat) %>% 
                             group_by(eng_desc) %>% 
                             filter(age_months == min(age_months)),
                           aes(label = eng_desc, hjust = 1))
```

Multi-panel.

```{r}
ggplot(filter(ms, !is.na(cat_name), 
              cat_name %in% c("cognitive","crawl","smile","walk")),
       aes(x = age_months, y = answer, col = eng_desc)) + 
  geom_point() + 
  geom_smooth(se=FALSE, span=4) + 
  scale_colour_solarized(guide=FALSE) + 
  facet_wrap(~cat_name) + 
  ylim(c(0,1)) + 
  geom_text(data = filter(ms, !is.na(cat_name), 
              cat_name %in% c("cognitive","crawl","smile","walk")) %>% 
              group_by(eng_desc) %>% 
              filter(age_months == min(age_months)),
            aes(label = eng_desc, hjust= 0), nudge_y = -.25)
```

Interactive by description. 

```{r, cache=FALSE}
ms$eng_desc <- factor(ms$eng_desc)

shinyApp(
  ui = fluidPage(
    selectizeInput("eng_descs", "Labels", #selected = c("Shakes objects"),
                   choices = gsub("[^[:alnum:] ]","",unique(ms$eng_desc)), 
                   multiple=TRUE),
    plotOutput("descplot")
  ),
  
  server = function(input, output) {
    output$descplot <- renderPlot({
      ggplot(filter(ms, eng_desc %in% input$eng_descs),
             aes(x = age_months, y = answer, col = eng_desc)) + 
        geom_point() + 
        geom_smooth(se=FALSE, span=4) + 
        scale_colour_solarized(guide=FALSE) + 
        ylim(c(0,1)) + 
        xlim(c(0,24)) + 
        ggrepel::geom_text_repel(data = filter(ms, eng_desc %in% input$eng_descs) %>% 
                                   group_by(eng_desc) %>% 
                                   filter(age_months == min(age_months)),
                                 aes(label = eng_desc))
    })
  },
  
  options = list(height = 700)
)

```

Interactive by category.

```{r, cache=FALSE}
library(shiny)
shinyApp(
  ui = fluidPage(
    selectInput("cat_name", "Category:", 
                choices = unique(ms$cat_name)),
    plotOutput("catplot")
  ),
  
  server = function(input, output) {
    output$catplot <- renderPlot({
      ggplot(filter(ms,cat_name == input$cat_name),
             aes(x = age_months, y = answer, col = eng_desc)) + 
        geom_point() + 
        geom_smooth(se=FALSE, method="lm", formula = y ~ log(x)) + 
        scale_colour_solarized(guide=FALSE) + 
        ylim(c(0,1)) + 
        ggrepel::geom_text_repel(data = filter(ms, cat_name == input$cat_name) %>% 
                                   group_by(eng_desc) %>% 
                                   filter(age_months == min(age_months)),
                                 aes(label = eng_desc))
    })
  },
  
  options = list(height = 700)
)
```